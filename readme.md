# Flask-Backgammon-API

Серверная часть (backend) для многопользовательской онлайн-игры в нарды. Этот проект построен на Flask и использует Flask-SocketIO для обработки игровой логики в реальном времени, а также REST API на Flask для аутентификации, управления пользователями и ассетами.

## Основные возможности

* **Аутентификация:** Безопасная аутентификация пользователей с использованием JSON Web Tokens (JWT).
* **Real-time геймплей:** Использование веб-сокетов (SocketIO) для мгновенной обработки ходов, подключения и других игровых событий.
* **Матчмейкинг:** Сервис для подбора оппонентов.
* **Управление играми:** Централизованные сервисы для создания, отслеживания (Registry) и завершения игровых сессий.
* **Игра против ИИ:** Встроенный контроллер (`AIController`) для возможности игры против компьютера.
* **Система наград:** Базовая логика для начисления ELO и игровой валюты за победы и поражения.
* **Управление ассетами:** API для загрузки и получения аватаров и баннеров.
* **Фоновая обработка:** Используется очередь уведомлений для асинхронной отправки данных клиентам.
* **Ограничение запросов:** Встроенный `Flask-Limiter` для защиты API от брутфорс-атак.
* **Логирование:** Ведение логов приложения и отдельного лога для статистики матчей.

## Технологический стек

Проект использует следующие основные технологии:

* **Flask:** Основной веб-фреймворк.
* **Flask-SocketIO:** Для real-time коммуникаций (веб-сокеты).
* **Flask-JWT-Extended:** Для аутентификации по JSON Web Tokens.
* **Flask-Limiter:** Для ограничения частоты запросов (rate limiting).
* **Eventlet:** Асинхронный сервер, необходимый для `Flask-SocketIO` в production.
* **Gunicorn:** WSGI-сервер для запуска в production.

## Установка

Для локального запуска проекта выполните следующие шаги:

1.  **Клонируйте репозиторий:**
    ```
    git clone [your-repository-url]
    cd flask-backgammon-api
    ```

2.  **Создайте и активируйте виртуальное окружение:**
    ```
    # Для Windows
    python -m venv venv
    .\venv\Scripts\activate
    
    # Для macOS/Linux
    python3 -m venv venv
    source venv/bin/activate
    ```

3.  **Установите зависимости:**
    ```
    pip install -r requirements.txt
    ```

## Конфигурация

Проект использует "Application Factory" паттерн и загружает конфигурацию из нескольких источников. Основная конфигурация находится в `app/config.py`.

Для переопределения настроек (например, для production) используется папка `instance`.

1.  **Создайте папку `instance`** в корневом каталоге проекта (рядом с `app` и `run.py`), если она не существует.

2.  **Создайте файл `instance/config.py`**. Этот файл *не* должен отслеживаться системой контроля версий (он должен быть в `.gitignore`).

3.  **Добавьте в `instance/config.py`** как минимум секретный ключ для JWT:

    ```python
    # instance/config.py
    
    # ВАЖНО: Замените этот ключ на свой собственный!
    # Можно сгенерировать с помощью: openssl rand -hex 32
    JWT_SECRET_KEY = 'your_super_secret_and_long_jwt_key_here'
    
    # Здесь можно переопределить и другие настройки из app/config.py
    # Например, путь к базе данных:
    # DB_FILE = 'production_users.db'
    ```

Приложение автоматически создаст базу данных `users.db` и лог-файлы (`application.log`, `match_stats.log`) в этой же папке `instance`.

## Запуск приложения

Точкой входа для запуска сервера является файл `run.py`. Он поддерживает два режима запуска: `local` (для разработки) и `prod` (для production).

### 1. Режим разработки (Local)

Этот режим используется по умолчанию. Сервер будет запущен на `127.0.0.1:4999` с включенным режимом отладки (debug) и автоматической перезагрузкой.

```bash
# Запуск по умолчанию
python run.py

# Или явно
python run.py -e local
````

### 2\. Режим Production

Этот режим предназначен для запуска на боевом сервере. Он запускает приложение на `0.0.0.0:5000` без режима отладки.

```bash
python run.py -e prod
```

**Примечание:** Для реального production-деплоя рекомендуется использовать Gunicorn + Eventlet напрямую, как указано в `requirements.txt`, а не `socketio.run()`. `run.py -e prod` полезен для тестирования в окружении, близком к production.

## Структура проекта

```
flask-backgammon-api/
│
├── app/                  # Главный модуль приложения
│   ├── api/              # Blueprints (маршруты) REST API (auth, files, main)
│   ├── game_core/        # Ядро игровой логики (ИИ, состояние доски, генератор ходов)
│   ├── services/         # Бизнес-логика (GameService, MatchmakingService, UserService)
│   ├── sockets/          # Обработчики событий SocketIO (connection, game)
│   ├── __init__.py       # Фабрика приложений (create_app)
│   ├── config.py         # Базовый класс конфигурации
│   ├── extensions.py     # Инициализация расширений (SocketIO, JWT, Limiter)
│   ├── globals.py        # Глобальные объекты (очереди, логгеры)
│   └── workers.py        # Фоновые обработчики (потребитель очереди)
│
├── instance/             # Папка для "секретной" конфигурации и данных (БД, логи)
│   ├── config.py         # (Создается вручную) Секреты и production-настройки
│   └── users.db          # (Создается автоматически) База данных SQLite
│
├── static/               # Статические файлы (не код)
│   ├── avatars/          # Аватары пользователей
│   ├── banners/          # Баннеры
│   └── public/           # Публичные ассеты
│
├── readme.md             # Этот файл
├── requirements.txt      # Зависимости Python
└── run.py                # Точка входа для запуска сервера
```
v0.18
